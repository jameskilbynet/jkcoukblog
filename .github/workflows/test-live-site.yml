name: Test Live Site Formatting

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      test_url:
        description: 'URL to test (default: production site)'
        required: false
        default: 'https://jameskilby.co.uk'
        type: choice
        options:
          - 'https://jameskilby.co.uk'
          - 'https://jkcoukblog.pages.dev'
      test_post:
        description: 'Also test a specific post page (leave empty to skip)'
        required: false
        default: ''
        type: string

jobs:
  test-site:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
        
    - name: Install dependencies
      run: |
        echo "üîß Installing Python dependencies..."
        pip install -r requirements.txt
        echo "‚úÖ Dependencies installed"
        
    - name: Test live site (main URL)
      id: test_main
      run: |
        echo "üöÄ Testing ${{ github.event.inputs.test_url }}..."
        
        # Run the test and capture output
        OUTPUT_FILE="test_output_main.txt"
        python3 test_live_site_formatting.py --url "${{ github.event.inputs.test_url }}" > "$OUTPUT_FILE" 2>&1
        TEST_EXIT_CODE=$?
        
        # Save output for later use
        cat "$OUTPUT_FILE"
        
        # Extract summary information
        PASSED=$(grep "tests passed" "$OUTPUT_FILE" | grep -oE '[0-9]+/[0-9]+' | head -1 || echo "0/0")
        ERRORS=$(grep "Errors:" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")
        WARNINGS=$(grep "Warnings:" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")
        
        # Save to environment for Slack notification
        echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
        echo "ERRORS=$ERRORS" >> $GITHUB_OUTPUT
        echo "WARNINGS=$WARNINGS" >> $GITHUB_OUTPUT
        echo "EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
        
        # Save detailed output
        {
          echo 'DETAILED_OUTPUT<<EOF'
          cat "$OUTPUT_FILE"
          echo 'EOF'
        } >> $GITHUB_OUTPUT
        
    - name: Test post page (if specified)
      id: test_post
      if: github.event.inputs.test_post != ''
      run: |
        echo "üöÄ Testing post page: ${{ github.event.inputs.test_post }}..."
        
        # Run the test and capture output
        OUTPUT_FILE="test_output_post.txt"
        python3 test_live_site_formatting.py --url "${{ github.event.inputs.test_post }}" > "$OUTPUT_FILE" 2>&1
        TEST_EXIT_CODE=$?
        
        # Save output for later use
        cat "$OUTPUT_FILE"
        
        # Extract summary information
        PASSED=$(grep "tests passed" "$OUTPUT_FILE" | grep -oE '[0-9]+/[0-9]+' | head -1 || echo "0/0")
        ERRORS=$(grep "Errors:" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")
        WARNINGS=$(grep "Warnings:" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")
        
        # Save to environment for Slack notification
        echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
        echo "ERRORS=$ERRORS" >> $GITHUB_OUTPUT
        echo "WARNINGS=$WARNINGS" >> $GITHUB_OUTPUT
        echo "EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Step Summary
      if: always()
      run: |
        echo "# üß™ Live Site Formatting Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Main URL results
        echo "## üåê Main URL Test" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** ${{ github.event.inputs.test_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests Passed:** ${{ steps.test_main.outputs.PASSED }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Errors:** ${{ steps.test_main.outputs.ERRORS }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Warnings:** ${{ steps.test_main.outputs.WARNINGS }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.test_main.outputs.EXIT_CODE }}" -eq 0 ]; then
          echo "- **Status:** ‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status:** ‚ùå Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Post page results (if tested)
        if [ -n "${{ github.event.inputs.test_post }}" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìÑ Post Page Test" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ github.event.inputs.test_post }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Passed:** ${{ steps.test_post.outputs.PASSED }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Errors:** ${{ steps.test_post.outputs.ERRORS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Warnings:** ${{ steps.test_post.outputs.WARNINGS }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test_post.outputs.EXIT_CODE }}" -eq 0 ]; then
            echo "- **Status:** ‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** ‚ùå Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Triggered by: @${{ github.actor }}*" >> $GITHUB_STEP_SUMMARY
        
    - name: Send Slack notification
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        # Check if Slack webhook is configured
        if [ -z "$SLACK_WEBHOOK_URL" ]; then
          echo "‚ÑπÔ∏è  SLACK_WEBHOOK_URL not configured, skipping Slack notification"
          exit 0
        fi
        
        # Determine overall status
        MAIN_STATUS="${{ steps.test_main.outputs.EXIT_CODE }}"
        
        if [ "$MAIN_STATUS" -eq 0 ]; then
          STATUS_ICON="‚úÖ"
          STATUS_TEXT="Passed"
          COLOR="good"
        else
          STATUS_ICON="‚ùå"
          STATUS_TEXT="Failed"
          COLOR="danger"
        fi
        
        # Build error/warning list
        ERROR_LIST=""
        if [ "${{ steps.test_main.outputs.ERRORS }}" -gt 0 ]; then
          ERROR_LIST="${ERROR_LIST}‚Ä¢ ${{ steps.test_main.outputs.ERRORS }} error(s) found\n"
        fi
        if [ "${{ steps.test_main.outputs.WARNINGS }}" -gt 0 ]; then
          ERROR_LIST="${ERROR_LIST}‚Ä¢ ${{ steps.test_main.outputs.WARNINGS }} warning(s) found\n"
        fi
        
        # Add post page results if tested
        POST_SECTION=""
        if [ -n "${{ github.event.inputs.test_post }}" ]; then
          POST_STATUS="${{ steps.test_post.outputs.EXIT_CODE }}"
          if [ "$POST_STATUS" -eq 0 ]; then
            POST_ICON="‚úÖ"
          else
            POST_ICON="‚ùå"
            COLOR="danger"  # Change overall color if post fails
          fi
          
          POST_SECTION=",
          {
            \"type\": \"section\",
            \"text\": {
              \"type\": \"mrkdwn\",
              \"text\": \"*üìÑ Post Page Test:* $POST_ICON\n${{ github.event.inputs.test_post }}\n‚Ä¢ Tests: ${{ steps.test_post.outputs.PASSED }}\n‚Ä¢ Errors: ${{ steps.test_post.outputs.ERRORS }}\n‚Ä¢ Warnings: ${{ steps.test_post.outputs.WARNINGS }}\"
            }
          }"
        fi
        
        # Send to Slack
        curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d @- << EOF
        {
          "text": "Live Site Formatting Test: $STATUS_ICON $STATUS_TEXT",
          "attachments": [
            {
              "color": "$COLOR",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "$STATUS_ICON Live Site Formatting Test: $STATUS_TEXT",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üåê Main URL Test:*\n${{ github.event.inputs.test_url }}\n‚Ä¢ Tests passed: ${{ steps.test_main.outputs.PASSED }}\n‚Ä¢ Errors: ${{ steps.test_main.outputs.ERRORS }}\n‚Ä¢ Warnings: ${{ steps.test_main.outputs.WARNINGS }}"
                  }
                }$POST_SECTION,
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Triggered by *${{ github.actor }}* | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                    }
                  ]
                }
              ]
            }
          ]
        }
        EOF
        
        echo "‚úÖ Slack notification sent"
        
    - name: Fail workflow if tests failed
      if: steps.test_main.outputs.EXIT_CODE != '0'
      run: |
        echo "‚ùå Tests failed with exit code ${{ steps.test_main.outputs.EXIT_CODE }}"
        exit 1
