name: Rollback Site to Previous Commit

on:
  workflow_dispatch:        # Manual trigger only

jobs:
  rollback:
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history to see previous commits
        
    - name: Validate rollback is possible
      run: |
        echo "üîç Checking if rollback is possible..."
        
        # Get current commit and previous commit
        CURRENT_COMMIT=$(git rev-parse HEAD)
        PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
        
        echo "üìå Current commit: $CURRENT_COMMIT"
        echo "üìå Previous commit: $PREVIOUS_COMMIT"
        
        # Check if previous commit exists
        if [ -z "$PREVIOUS_COMMIT" ]; then
          echo "‚ùå No previous commit found. Cannot rollback."
          exit 1
        fi
        
        # Show what we're rolling back
        echo ""
        echo "üìã Current commit details:"
        git log -1 --pretty=format:"  Author: %an%n  Date: %ad%n  Message: %s" HEAD
        echo ""
        echo ""
        echo "üìã Rolling back to:"
        git log -1 --pretty=format:"  Author: %an%n  Date: %ad%n  Message: %s" HEAD~1
        echo ""
        
        # Save for later steps
        echo "CURRENT_COMMIT=$CURRENT_COMMIT" >> $GITHUB_ENV
        echo "PREVIOUS_COMMIT=$PREVIOUS_COMMIT" >> $GITHUB_ENV
        
    - name: Perform rollback
      run: |
        echo "üîÑ Rolling back to previous commit..."
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Sync with remote to ensure we're up to date
        git fetch origin
        
        # Reset to previous commit
        ROLLED_BACK_COMMIT=$(git log -1 --pretty=format:"%s" HEAD)
        git reset --hard HEAD~1
        
        echo "‚úÖ Rollback commit created"
        echo "üìù Reset to previous commit: $ROLLED_BACK_COMMIT"
        
    - name: Push rollback
      run: |
        echo "üì§ Pushing rollback to remote..."
        
        # Attempt push
        if git push origin main; then
          echo "‚úÖ Rollback pushed successfully"
        else
          echo "‚ö†Ô∏è Push failed, syncing with remote and retrying..."
          git fetch origin
          git reset --hard origin/main
          git reset --hard HEAD~1
          git push --force-with-lease origin main
        fi
        
        NEW_COMMIT=$(git rev-parse HEAD)
        echo "NEW_COMMIT=$NEW_COMMIT" >> $GITHUB_ENV
        
        echo "‚úÖ Site rolled back successfully"
        echo "üåê Cloudflare Pages will auto-deploy the rolled-back version"
        
    - name: Generate summary
      run: |
        echo "## ‚èÆÔ∏è Rollback Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ‚úÖ Successfully rolled back" >> $GITHUB_STEP_SUMMARY
        echo "- **Rolled back from:** \`${{ env.CURRENT_COMMIT }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Reverted to:** \`${{ env.PREVIOUS_COMMIT }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **New commit:** \`${{ env.NEW_COMMIT }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Cloudflare Pages:** Will auto-deploy the rolled-back version" >> $GITHUB_STEP_SUMMARY
        
    - name: Notify Slack on Success
      if: success()
      uses: slackapi/slack-github-action@v2.0.0
      with:
        webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
        webhook-type: incoming-webhook
        payload: |
          {
            "channel": "#web",
            "username": "GitHub Actions",
            "icon_emoji": ":github:",
            "attachments": [
              {
                "color": "warning",
                "title": "‚èÆÔ∏è jkcoukblog Site Rolled Back",
                "text": "The site has been rolled back to the previous version.",
                "fields": [
                  {
                    "title": "Rolled back from",
                    "value": "${{ env.CURRENT_COMMIT }}",
                    "short": true
                  },
                  {
                    "title": "Reverted to",
                    "value": "${{ env.PREVIOUS_COMMIT }}",
                    "short": true
                  },
                  {
                    "title": "Triggered by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "New Commit",
                    "value": "${{ env.NEW_COMMIT }}",
                    "short": true
                  }
                ],
                "footer": "üåê Cloudflare Pages will now deploy the rolled-back version",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "actions": [
                  {
                    "type": "button",
                    "text": "View Workflow",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
        
    - name: Notify Slack on Failure  
      if: failure()
      uses: slackapi/slack-github-action@v2.0.0
      with:
        webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
        webhook-type: incoming-webhook
        payload: |
          {
            "channel": "#web",
            "username": "GitHub Actions",
            "icon_emoji": ":github:",
            "attachments": [
              {
                "color": "danger",
                "title": "‚ùå jkcoukblog Rollback Failed",
                "text": "Failed to rollback the site to the previous version!",
                "fields": [
                  {
                    "title": "Triggered by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  }
                ],
                "footer": "Please check the GitHub Actions logs for details",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "actions": [
                  {
                    "type": "button",
                    "text": "View Workflow Logs",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
