name: WordPress to Staging Site Deploy

on:
  workflow_dispatch:        # Manual trigger only - no automatic deploys to staging

# Prevent concurrent runs of this workflow
concurrency:
  group: wordpress-staging-site-deploy
  cancel-in-progress: false

jobs:
  build-and-deploy-staging:
    runs-on: self-hosted
    timeout-minutes: 60
    
    steps:
    - name: Validate required environment variables
      run: |
        echo "üîç Validating required environment variables..."
        MISSING_VARS=()
        
        if [ -z "${{ secrets.WP_AUTH_TOKEN }}" ]; then
          MISSING_VARS+=("WP_AUTH_TOKEN")
        fi
        
        if [ ${#MISSING_VARS[@]} -gt 0 ]; then
          echo "‚ùå Missing required environment variables:"
          for var in "${MISSING_VARS[@]}"; do
            echo "  - $var"
          done
          exit 1
        else
          echo "‚úÖ All required environment variables are set"
        fi
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: staging
        fetch-depth: 0
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
        
    - name: Install dependencies
      run: |
        echo "üîß Installing Python dependencies..."
        pip install -r requirements.txt
        echo "‚úÖ Dependencies installed"
        
    - name: Generate static site (with drafts)
      timeout-minutes: 30
      env:
        WP_AUTH_TOKEN: ${{ secrets.WP_AUTH_TOKEN }}
      run: |
        echo "üé≠ STAGING BUILD: Including drafts and scheduled posts"
        echo "üìÅ Working from: $(pwd)"
        
        if [ ! -f "scripts/wp_to_static_generator.py" ]; then
          echo "‚ùå scripts/wp_to_static_generator.py not found!"
          exit 1
        fi
        
        # Generate site with --include-drafts flag
        python scripts/wp_to_static_generator.py ./static-output --include-drafts
        
        HTML_COUNT=$(find ./static-output -name "*.html" -type f 2>/dev/null | wc -l | xargs)
        TOTAL_SIZE=$(du -sh ./static-output 2>/dev/null | cut -f1)
        echo "üìä Generated $HTML_COUNT HTML files, total size: $TOTAL_SIZE"
        
        echo "HTML_COUNT=$HTML_COUNT" >> $GITHUB_ENV
        echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV
        
        echo "## üìä Staging Site Generation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Mode:** üé≠ Staging (includes drafts)" >> $GITHUB_STEP_SUMMARY
        echo "- **HTML Pages:** $HTML_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Size:** $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
        
    - name: Export to Markdown
      run: |
        echo "üìù Exporting content to markdown..."
        python scripts/markdown_exporter.py \
          ./static-output \
          ./static-output/markdown \
          https://jkcoukblog.pages.dev
        
    - name: Generate Markdown API
      run: |
        echo "üîå Generating markdown API..."
        python scripts/markdown_api.py \
          ./static-output/markdown \
          ./static-output/api
        
    - name: Validate HTML build
      timeout-minutes: 5
      continue-on-error: true
      run: |
        echo "üîç Validating generated HTML and assets..."
        python3 scripts/validate_html.py ./static-output || {
          echo "‚ö†Ô∏è  HTML validation found issues (non-blocking for staging)"
        }
        
    - name: Convert URLs for staging
      run: |
        rm -rf public-staging/
        mv ./static-output public-staging/
        
        echo "üîÑ Converting URLs for staging deployment..."
        python scripts/convert_to_staging.py
        
    - name: Commit and push to staging branch
      timeout-minutes: 10
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        echo "üìã Current state:"
        echo "Branch: $(git branch --show-current)"
        
        # Sync with remote
        git fetch origin staging
        git reset --hard origin/staging
        
        # Add generated files
        git add public-staging/
        
        if [ -n "$(git diff --cached)" ]; then
          echo "üìù Changes detected, committing..."
          git commit -m "üé≠ Auto-update staging site - $(date '+%Y-%m-%d %H:%M:%S')

Co-Authored-By: Warp <agent@warp.dev>"
          
          if git push origin staging; then
            echo "‚úÖ Push successful"
          else
            echo "‚ö†Ô∏è  Push failed, retrying..."
            git fetch origin staging
            if git rebase origin/staging; then
              git push origin staging
            else
              git rebase --abort
              git reset --hard origin/staging
              echo "‚ùå Could not push to staging branch"
              exit 1
            fi
          fi
          
          echo "‚úÖ Staging site updated"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üöÄ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ‚úÖ Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** public-staging/" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://jkcoukblog.pages.dev" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ÑπÔ∏è  No changes to commit"
        fi
        
    - name: Notify on success
      if: success()
      run: |
        echo "‚úÖ Staging site generated and deployed!"
        echo "üåê View at: https://jkcoukblog.pages.dev"
        echo "üé≠ This build includes drafts and scheduled posts"
        
    - name: Notify Slack on Success
      if: success()
      uses: slackapi/slack-github-action@v2.0.0
      with:
        webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
        webhook-type: incoming-webhook
        payload: |
          {
            "channel": "#web",
            "username": "GitHub Actions",
            "icon_emoji": ":github:",
            "attachments": [
              {
                "color": "good",
                "title": "üé≠ Staging Site Deployed",
                "text": "jkcoukblog staging site updated (includes drafts)",
                "fields": [
                  {
                    "title": "HTML Pages",
                    "value": "${{ env.HTML_COUNT }}",
                    "short": true
                  },
                  {
                    "title": "Site Size",
                    "value": "${{ env.TOTAL_SIZE }}",
                    "short": true
                  },
                  {
                    "title": "URL",
                    "value": "https://jkcoukblog.pages.dev",
                    "short": false
                  }
                ],
                "footer": "Staging branch deployed to Cloudflare Pages",
                "actions": [
                  {
                    "type": "button",
                    "text": "View Staging Site",
                    "url": "https://jkcoukblog.pages.dev"
                  },
                  {
                    "type": "button",
                    "text": "View Workflow",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
