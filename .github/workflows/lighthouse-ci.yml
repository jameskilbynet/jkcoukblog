name: Lighthouse CI Performance Monitoring

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual triggers
  schedule:
    # Run daily at 3 AM UTC to track performance trends
    - cron: '0 3 * * *'

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Wait for deployment
        if: github.event_name == 'push'
        run: |
          echo "‚è≥ Waiting 2 minutes for Cloudflare Pages to deploy..."
          sleep 120
      
      - name: Check if config files exist
        id: check_configs
        run: |
          if [ -f ".github/lighthouse/budget.json" ]; then
            echo "budget_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Budget config found"
          else
            echo "budget_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Budget config not found, will use defaults"
          fi
          
          if [ -f ".github/lighthouse/lighthouse-config.json" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Lighthouse config found"
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Lighthouse config not found, will use defaults"
          fi
      
      - name: Run Lighthouse CI (with configs)
        if: steps.check_configs.outputs.budget_exists == 'true' && steps.check_configs.outputs.config_exists == 'true'
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            https://jameskilby.co.uk
            https://jameskilby.co.uk/category/
            https://jameskilby.co.uk/2025/
          runs: 3
          uploadArtifacts: true
          temporaryPublicStorage: true
          budgetPath: .github/lighthouse/budget.json
          configPath: .github/lighthouse/lighthouse-config.json
      
      - name: Run Lighthouse CI (without configs)
        if: steps.check_configs.outputs.budget_exists == 'false' || steps.check_configs.outputs.config_exists == 'false'
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            https://jameskilby.co.uk
            https://jameskilby.co.uk/category/
            https://jameskilby.co.uk/2025/
          runs: 3
          uploadArtifacts: true
          temporaryPublicStorage: true
      
      - name: Generate performance summary
        if: always()
        run: |
          echo "## üö¶ Lighthouse Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Performance metrics have been collected for:" >> $GITHUB_STEP_SUMMARY
          echo "- Homepage: https://jameskilby.co.uk" >> $GITHUB_STEP_SUMMARY
          echo "- Category page: https://jameskilby.co.uk/category/" >> $GITHUB_STEP_SUMMARY
          echo "- Recent posts: https://jameskilby.co.uk/2025/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä **Metrics tracked:**" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Score" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility Score" >> $GITHUB_STEP_SUMMARY
          echo "- Best Practices Score" >> $GITHUB_STEP_SUMMARY
          echo "- SEO Score" >> $GITHUB_STEP_SUMMARY
          echo "- First Contentful Paint (FCP)" >> $GITHUB_STEP_SUMMARY
          echo "- Largest Contentful Paint (LCP)" >> $GITHUB_STEP_SUMMARY
          echo "- Time to Interactive (TTI)" >> $GITHUB_STEP_SUMMARY
          echo "- Cumulative Layout Shift (CLS)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed reports in the artifacts section." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports are automatically uploaded by Lighthouse CI action." >> $GITHUB_STEP_SUMMARY
          if [ -d ".lighthouseci" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìÅ Lighthouse results available in workflow artifacts." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Parse Lighthouse results
        id: lighthouse_results
        if: always()
        continue-on-error: true
        run: |
          # Find the most recent Lighthouse report
          REPORT=$(ls -t .lighthouseci/lhr-*.json 2>/dev/null | head -1)
          
          if [ -f "$REPORT" ]; then
            echo "‚úÖ Found Lighthouse report: $REPORT"
            
            # Extract scores using jq (performance, accessibility, best-practices, seo)
            PERF=$(jq -r '.categories.performance.score * 100 | floor' "$REPORT")
            A11Y=$(jq -r '.categories.accessibility.score * 100 | floor' "$REPORT")
            BP=$(jq -r '.categories["best-practices"].score * 100 | floor' "$REPORT")
            SEO=$(jq -r '.categories.seo.score * 100 | floor' "$REPORT")
            
            # Extract Core Web Vitals
            LCP=$(jq -r '.audits["largest-contentful-paint"].displayValue // "N/A"' "$REPORT")
            FCP=$(jq -r '.audits["first-contentful-paint"].displayValue // "N/A"' "$REPORT")
            CLS=$(jq -r '.audits["cumulative-layout-shift"].displayValue // "N/A"' "$REPORT")
            TTI=$(jq -r '.audits.interactive.displayValue // "N/A"' "$REPORT")
            SI=$(jq -r '.audits["speed-index"].displayValue // "N/A"' "$REPORT")
            TBT=$(jq -r '.audits["total-blocking-time"].displayValue // "N/A"' "$REPORT")
            
            # Get URL that was tested
            URL=$(jq -r '.finalUrl' "$REPORT")
            
            # Save to outputs
            echo "performance=$PERF" >> $GITHUB_OUTPUT
            echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
            echo "best_practices=$BP" >> $GITHUB_OUTPUT
            echo "seo=$SEO" >> $GITHUB_OUTPUT
            echo "lcp=$LCP" >> $GITHUB_OUTPUT
            echo "fcp=$FCP" >> $GITHUB_OUTPUT
            echo "cls=$CLS" >> $GITHUB_OUTPUT
            echo "tti=$TTI" >> $GITHUB_OUTPUT
            echo "speed_index=$SI" >> $GITHUB_OUTPUT
            echo "tbt=$TBT" >> $GITHUB_OUTPUT
            echo "url=$URL" >> $GITHUB_OUTPUT
            echo "has_results=true" >> $GITHUB_OUTPUT
            
            # Determine overall status (green if all above 90)
            if [ "$PERF" -ge 90 ] && [ "$A11Y" -ge 90 ] && [ "$BP" -ge 90 ] && [ "$SEO" -ge 90 ]; then
              echo "status=good" >> $GITHUB_OUTPUT
            elif [ "$PERF" -lt 50 ] || [ "$A11Y" -lt 50 ] || [ "$BP" -lt 50 ] || [ "$SEO" -lt 50 ]; then
              echo "status=danger" >> $GITHUB_OUTPUT
            else
              echo "status=warning" >> $GITHUB_OUTPUT
            fi
            
            echo "üìä Scores: Performance=$PERF, A11y=$A11Y, BP=$BP, SEO=$SEO"
          else
            echo "‚ö†Ô∏è  No Lighthouse reports found"
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Notify Slack with metrics (on push/PR)
        if: always() && steps.lighthouse_results.outputs.has_results == 'true' && (github.event_name == 'push' || github.event_name == 'pull_request')
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "#web",
              "username": "Lighthouse CI",
              "icon_emoji": ":lighthouse:",
              "attachments": [
                {
                  "color": "${{ steps.lighthouse_results.outputs.status }}",
                  "title": "üöÄ Lighthouse Performance Report",
                  "text": "Performance metrics for <${{ steps.lighthouse_results.outputs.url }}|jameskilby.co.uk>",
                  "fields": [
                    {
                      "title": "üéØ Performance",
                      "value": "${{ steps.lighthouse_results.outputs.performance }}/100",
                      "short": true
                    },
                    {
                      "title": "‚ôø Accessibility",
                      "value": "${{ steps.lighthouse_results.outputs.accessibility }}/100",
                      "short": true
                    },
                    {
                      "title": "‚úÖ Best Practices",
                      "value": "${{ steps.lighthouse_results.outputs.best_practices }}/100",
                      "short": true
                    },
                    {
                      "title": "üîç SEO",
                      "value": "${{ steps.lighthouse_results.outputs.seo }}/100",
                      "short": true
                    },
                    {
                      "title": "üìà LCP (Largest Contentful Paint)",
                      "value": "${{ steps.lighthouse_results.outputs.lcp }}",
                      "short": true
                    },
                    {
                      "title": "‚ö° FCP (First Contentful Paint)",
                      "value": "${{ steps.lighthouse_results.outputs.fcp }}",
                      "short": true
                    },
                    {
                      "title": "üìä CLS (Cumulative Layout Shift)",
                      "value": "${{ steps.lighthouse_results.outputs.cls }}",
                      "short": true
                    },
                    {
                      "title": "üïí TTI (Time to Interactive)",
                      "value": "${{ steps.lighthouse_results.outputs.tti }}",
                      "short": true
                    },
                    {
                      "title": "Triggered By",
                      "value": "${{ github.actor }} (${{ github.event_name }})",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    }
                  ],
                  "footer": "Lighthouse CI | View detailed reports in workflow artifacts",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Full Report",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Notify Slack with daily metrics
        if: github.event_name == 'schedule' && steps.lighthouse_results.outputs.has_results == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "#web",
              "username": "Lighthouse CI",
              "icon_emoji": ":lighthouse:",
              "attachments": [
                {
                  "color": "${{ steps.lighthouse_results.outputs.status }}",
                  "title": "üìÖ Daily Performance Report",
                  "text": "Daily Lighthouse scan results for jameskilby.co.uk",
                  "fields": [
                    {
                      "title": "üéØ Performance",
                      "value": "${{ steps.lighthouse_results.outputs.performance }}/100",
                      "short": true
                    },
                    {
                      "title": "‚ôø Accessibility",
                      "value": "${{ steps.lighthouse_results.outputs.accessibility }}/100",
                      "short": true
                    },
                    {
                      "title": "‚úÖ Best Practices",
                      "value": "${{ steps.lighthouse_results.outputs.best_practices }}/100",
                      "short": true
                    },
                    {
                      "title": "üîç SEO",
                      "value": "${{ steps.lighthouse_results.outputs.seo }}/100",
                      "short": true
                    },
                    {
                      "title": "Core Web Vitals",
                      "value": "LCP: ${{ steps.lighthouse_results.outputs.lcp }} | CLS: ${{ steps.lighthouse_results.outputs.cls }}",
                      "short": false
                    }
                  ],
                  "footer": "Lighthouse CI - Daily Monitoring at 3 AM UTC",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Full Report",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
