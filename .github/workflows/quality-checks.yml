name: Quality Checks

on:
  push:
    branches: [main, master]
    paths:
      - 'public/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'public/**'
  workflow_dispatch:
    inputs:
      run_lighthouse:
        description: 'Run Lighthouse performance tests'
        required: false
        default: true
        type: boolean
      run_formatting:
        description: 'Run site formatting tests'
        required: false
        default: true
        type: boolean
      test_url:
        description: 'URL to test for formatting (default: production)'
        required: false
        default: 'https://jameskilby.co.uk'
        type: choice
        options:
          - 'https://jameskilby.co.uk'
          - 'https://jkcoukblog.pages.dev'
      test_post:
        description: 'Specific post URL to test (leave empty to skip)'
        required: false
        default: ''
        type: string
  schedule:
    # Run daily at 3 AM UTC to track performance trends
    - cron: '0 3 * * *'

jobs:
  lighthouse:
    name: Lighthouse Performance
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_lighthouse == 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for deployment
        if: github.event_name == 'push'
        run: |
          echo "‚è≥ Waiting 2 minutes for Cloudflare Pages to deploy..."
          sleep 120

      - name: Check if config files exist
        id: check_configs
        run: |
          if [ -f ".github/lighthouse/budget.json" ]; then
            echo "budget_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Budget config found"
          else
            echo "budget_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Budget config not found, will use defaults"
          fi

          if [ -f ".github/lighthouse/lighthouse-config.json" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Lighthouse config found"
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Lighthouse config not found, will use defaults"
          fi

      - name: Run Lighthouse CI (with configs)
        if: steps.check_configs.outputs.budget_exists == 'true' && steps.check_configs.outputs.config_exists == 'true'
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            https://jameskilby.co.uk
            https://jameskilby.co.uk/category/
            https://jameskilby.co.uk/2025/
          runs: 3
          uploadArtifacts: true
          temporaryPublicStorage: true
          budgetPath: .github/lighthouse/budget.json
          configPath: .github/lighthouse/lighthouse-config.json

      - name: Run Lighthouse CI (without configs)
        if: steps.check_configs.outputs.budget_exists == 'false' || steps.check_configs.outputs.config_exists == 'false'
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            https://jameskilby.co.uk
            https://jameskilby.co.uk/category/
            https://jameskilby.co.uk/2025/
          runs: 3
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Generate performance summary
        if: always()
        run: |
          echo "## üö¶ Lighthouse Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Performance metrics have been collected for:" >> $GITHUB_STEP_SUMMARY
          echo "- Homepage: https://jameskilby.co.uk" >> $GITHUB_STEP_SUMMARY
          echo "- Category page: https://jameskilby.co.uk/category/" >> $GITHUB_STEP_SUMMARY
          echo "- Recent posts: https://jameskilby.co.uk/2025/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä **Metrics tracked:**" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Score" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility Score" >> $GITHUB_STEP_SUMMARY
          echo "- Best Practices Score" >> $GITHUB_STEP_SUMMARY
          echo "- SEO Score" >> $GITHUB_STEP_SUMMARY
          echo "- First Contentful Paint (FCP)" >> $GITHUB_STEP_SUMMARY
          echo "- Largest Contentful Paint (LCP)" >> $GITHUB_STEP_SUMMARY
          echo "- Time to Interactive (TTI)" >> $GITHUB_STEP_SUMMARY
          echo "- Cumulative Layout Shift (CLS)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed reports in the artifacts section." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports are automatically uploaded by Lighthouse CI action." >> $GITHUB_STEP_SUMMARY
          if [ -d ".lighthouseci" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìÅ Lighthouse results available in workflow artifacts." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Parse Lighthouse results
        id: lighthouse_results
        if: always()
        continue-on-error: true
        run: |
          # Find the most recent Lighthouse report
          REPORT=$(ls -t .lighthouseci/lhr-*.json 2>/dev/null | head -1)

          if [ -f "$REPORT" ]; then
            echo "‚úÖ Found Lighthouse report: $REPORT"

            # Extract scores using jq (performance, accessibility, best-practices, seo)
            PERF=$(jq -r '.categories.performance.score * 100 | floor' "$REPORT")
            A11Y=$(jq -r '.categories.accessibility.score * 100 | floor' "$REPORT")
            BP=$(jq -r '.categories["best-practices"].score * 100 | floor' "$REPORT")
            SEO=$(jq -r '.categories.seo.score * 100 | floor' "$REPORT")

            # Extract Core Web Vitals
            LCP=$(jq -r '.audits["largest-contentful-paint"].displayValue // "N/A"' "$REPORT")
            FCP=$(jq -r '.audits["first-contentful-paint"].displayValue // "N/A"' "$REPORT")
            CLS=$(jq -r '.audits["cumulative-layout-shift"].displayValue // "N/A"' "$REPORT")
            TTI=$(jq -r '.audits.interactive.displayValue // "N/A"' "$REPORT")
            SI=$(jq -r '.audits["speed-index"].displayValue // "N/A"' "$REPORT")
            TBT=$(jq -r '.audits["total-blocking-time"].displayValue // "N/A"' "$REPORT")

            # Get URL that was tested
            URL=$(jq -r '.finalUrl' "$REPORT")

            # Save to outputs
            echo "performance=$PERF" >> $GITHUB_OUTPUT
            echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
            echo "best_practices=$BP" >> $GITHUB_OUTPUT
            echo "seo=$SEO" >> $GITHUB_OUTPUT
            echo "lcp=$LCP" >> $GITHUB_OUTPUT
            echo "fcp=$FCP" >> $GITHUB_OUTPUT
            echo "cls=$CLS" >> $GITHUB_OUTPUT
            echo "tti=$TTI" >> $GITHUB_OUTPUT
            echo "speed_index=$SI" >> $GITHUB_OUTPUT
            echo "tbt=$TBT" >> $GITHUB_OUTPUT
            echo "url=$URL" >> $GITHUB_OUTPUT
            echo "has_results=true" >> $GITHUB_OUTPUT

            # Determine overall status (green if all above 90)
            if [ "$PERF" -ge 90 ] && [ "$A11Y" -ge 90 ] && [ "$BP" -ge 90 ] && [ "$SEO" -ge 90 ]; then
              echo "status=good" >> $GITHUB_OUTPUT
            elif [ "$PERF" -lt 50 ] || [ "$A11Y" -lt 50 ] || [ "$BP" -lt 50 ] || [ "$SEO" -lt 50 ]; then
              echo "status=danger" >> $GITHUB_OUTPUT
            else
              echo "status=warning" >> $GITHUB_OUTPUT
            fi

            echo "üìä Scores: Performance=$PERF, A11y=$A11Y, BP=$BP, SEO=$SEO"
          else
            echo "‚ö†Ô∏è  No Lighthouse reports found"
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack with metrics (on push/PR)
        if: always() && steps.lighthouse_results.outputs.has_results == 'true' && (github.event_name == 'push' || github.event_name == 'pull_request')
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "#web",
              "username": "Lighthouse CI",
              "icon_emoji": ":lighthouse:",
              "attachments": [
                {
                  "color": "${{ steps.lighthouse_results.outputs.status }}",
                  "title": "üöÄ Lighthouse Performance Report",
                  "text": "Performance metrics for <${{ steps.lighthouse_results.outputs.url }}|jameskilby.co.uk>",
                  "fields": [
                    {
                      "title": "üéØ Performance",
                      "value": "${{ steps.lighthouse_results.outputs.performance }}/100",
                      "short": true
                    },
                    {
                      "title": "‚ôø Accessibility",
                      "value": "${{ steps.lighthouse_results.outputs.accessibility }}/100",
                      "short": true
                    },
                    {
                      "title": "‚úÖ Best Practices",
                      "value": "${{ steps.lighthouse_results.outputs.best_practices }}/100",
                      "short": true
                    },
                    {
                      "title": "üîç SEO",
                      "value": "${{ steps.lighthouse_results.outputs.seo }}/100",
                      "short": true
                    },
                    {
                      "title": "üìà LCP (Largest Contentful Paint)",
                      "value": "${{ steps.lighthouse_results.outputs.lcp }}",
                      "short": true
                    },
                    {
                      "title": "‚ö° FCP (First Contentful Paint)",
                      "value": "${{ steps.lighthouse_results.outputs.fcp }}",
                      "short": true
                    },
                    {
                      "title": "üìä CLS (Cumulative Layout Shift)",
                      "value": "${{ steps.lighthouse_results.outputs.cls }}",
                      "short": true
                    },
                    {
                      "title": "üïí TTI (Time to Interactive)",
                      "value": "${{ steps.lighthouse_results.outputs.tti }}",
                      "short": true
                    },
                    {
                      "title": "Triggered By",
                      "value": "${{ github.actor }} (${{ github.event_name }})",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    }
                  ],
                  "footer": "Lighthouse CI | View detailed reports in workflow artifacts",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Full Report",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack with daily metrics
        if: github.event_name == 'schedule' && steps.lighthouse_results.outputs.has_results == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "#web",
              "username": "Lighthouse CI",
              "icon_emoji": ":lighthouse:",
              "attachments": [
                {
                  "color": "${{ steps.lighthouse_results.outputs.status }}",
                  "title": "üìÖ Daily Performance Report",
                  "text": "Daily Lighthouse scan results for jameskilby.co.uk",
                  "fields": [
                    {
                      "title": "üéØ Performance",
                      "value": "${{ steps.lighthouse_results.outputs.performance }}/100",
                      "short": true
                    },
                    {
                      "title": "‚ôø Accessibility",
                      "value": "${{ steps.lighthouse_results.outputs.accessibility }}/100",
                      "short": true
                    },
                    {
                      "title": "‚úÖ Best Practices",
                      "value": "${{ steps.lighthouse_results.outputs.best_practices }}/100",
                      "short": true
                    },
                    {
                      "title": "üîç SEO",
                      "value": "${{ steps.lighthouse_results.outputs.seo }}/100",
                      "short": true
                    },
                    {
                      "title": "Core Web Vitals",
                      "value": "LCP: ${{ steps.lighthouse_results.outputs.lcp }} | CLS: ${{ steps.lighthouse_results.outputs.cls }}",
                      "short": false
                    }
                  ],
                  "footer": "Lighthouse CI - Daily Monitoring at 3 AM UTC",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Full Report",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  formatting:
    name: Site Formatting Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.run_formatting == 'true'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: Install dependencies
      run: |
        echo "üîß Installing Python dependencies..."
        pip install -r requirements.txt
        echo "‚úÖ Dependencies installed"

    - name: Test live site (main URL)
      id: test_main
      run: |
        echo "üöÄ Testing ${{ github.event.inputs.test_url }}..."

        # Run the test and capture output
        OUTPUT_FILE="test_output_main.txt"
        python3 scripts/test_live_site_formatting.py --url "${{ github.event.inputs.test_url }}" > "$OUTPUT_FILE" 2>&1
        TEST_EXIT_CODE=$?

        # Save output for later use
        cat "$OUTPUT_FILE"

        # Extract summary information
        PASSED=$(grep "tests passed" "$OUTPUT_FILE" | grep -oE '[0-9]+/[0-9]+' | head -1 || echo "0/0")
        ERRORS=$(grep "Errors:" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")
        WARNINGS=$(grep "Warnings:" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")

        # Save to environment for Slack notification
        echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
        echo "ERRORS=$ERRORS" >> $GITHUB_OUTPUT
        echo "WARNINGS=$WARNINGS" >> $GITHUB_OUTPUT
        echo "EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

        # Save detailed output
        {
          echo 'DETAILED_OUTPUT<<EOF'
          cat "$OUTPUT_FILE"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Test post page (if specified)
      id: test_post
      if: github.event.inputs.test_post != ''
      run: |
        echo "üöÄ Testing post page: ${{ github.event.inputs.test_post }}..."

        # Run the test and capture output
        OUTPUT_FILE="test_output_post.txt"
        python3 scripts/test_live_site_formatting.py --url "${{ github.event.inputs.test_post }}" > "$OUTPUT_FILE" 2>&1
        TEST_EXIT_CODE=$?

        # Save output for later use
        cat "$OUTPUT_FILE"

        # Extract summary information
        PASSED=$(grep "tests passed" "$OUTPUT_FILE" | grep -oE '[0-9]+/[0-9]+' | head -1 || echo "0/0")
        ERRORS=$(grep "Errors:" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")
        WARNINGS=$(grep "Warnings:" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1 || echo "0")

        # Save to environment for Slack notification
        echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
        echo "ERRORS=$ERRORS" >> $GITHUB_OUTPUT
        echo "WARNINGS=$WARNINGS" >> $GITHUB_OUTPUT
        echo "EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

    - name: Create GitHub Step Summary
      if: always()
      run: |
        echo "# üß™ Live Site Formatting Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Main URL results
        echo "## üåê Main URL Test" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** ${{ github.event.inputs.test_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests Passed:** ${{ steps.test_main.outputs.PASSED }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Errors:** ${{ steps.test_main.outputs.ERRORS }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Warnings:** ${{ steps.test_main.outputs.WARNINGS }}" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.test_main.outputs.EXIT_CODE }}" -eq 0 ]; then
          echo "- **Status:** ‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status:** ‚ùå Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi

        # Post page results (if tested)
        if [ -n "${{ github.event.inputs.test_post }}" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìÑ Post Page Test" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ github.event.inputs.test_post }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Passed:** ${{ steps.test_post.outputs.PASSED }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Errors:** ${{ steps.test_post.outputs.ERRORS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Warnings:** ${{ steps.test_post.outputs.WARNINGS }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test_post.outputs.EXIT_CODE }}" -eq 0 ]; then
            echo "- **Status:** ‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** ‚ùå Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Triggered by: @${{ github.actor }}*" >> $GITHUB_STEP_SUMMARY

    - name: Send Slack notification
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        # Check if Slack webhook is configured
        if [ -z "$SLACK_WEBHOOK_URL" ]; then
          echo "‚ÑπÔ∏è  SLACK_WEBHOOK_URL not configured, skipping Slack notification"
          exit 0
        fi

        # Determine overall status
        MAIN_STATUS="${{ steps.test_main.outputs.EXIT_CODE }}"

        if [ "$MAIN_STATUS" -eq 0 ]; then
          STATUS_ICON="‚úÖ"
          STATUS_TEXT="Passed"
          COLOR="good"
        else
          STATUS_ICON="‚ùå"
          STATUS_TEXT="Failed"
          COLOR="danger"
        fi

        # Build error/warning list
        ERROR_LIST=""
        if [ "${{ steps.test_main.outputs.ERRORS }}" -gt 0 ]; then
          ERROR_LIST="${ERROR_LIST}‚Ä¢ ${{ steps.test_main.outputs.ERRORS }} error(s) found\n"
        fi
        if [ "${{ steps.test_main.outputs.WARNINGS }}" -gt 0 ]; then
          ERROR_LIST="${ERROR_LIST}‚Ä¢ ${{ steps.test_main.outputs.WARNINGS }} warning(s) found\n"
        fi

        # Add post page results if tested
        POST_SECTION=""
        if [ -n "${{ github.event.inputs.test_post }}" ]; then
          POST_STATUS="${{ steps.test_post.outputs.EXIT_CODE }}"
          if [ "$POST_STATUS" -eq 0 ]; then
            POST_ICON="‚úÖ"
          else
            POST_ICON="‚ùå"
            COLOR="danger"  # Change overall color if post fails
          fi

          POST_SECTION=",
          {
            \"type\": \"section\",
            \"text\": {
              \"type\": \"mrkdwn\",
              \"text\": \"*üìÑ Post Page Test:* $POST_ICON\n${{ github.event.inputs.test_post }}\n‚Ä¢ Tests: ${{ steps.test_post.outputs.PASSED }}\n‚Ä¢ Errors: ${{ steps.test_post.outputs.ERRORS }}\n‚Ä¢ Warnings: ${{ steps.test_post.outputs.WARNINGS }}\"
            }
          }"
        fi

        # Send to Slack
        curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d @- << EOF
        {
          "text": "Live Site Formatting Test: $STATUS_ICON $STATUS_TEXT",
          "attachments": [
            {
              "color": "$COLOR",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "$STATUS_ICON Live Site Formatting Test: $STATUS_TEXT",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üåê Main URL Test:*\n${{ github.event.inputs.test_url }}\n‚Ä¢ Tests passed: ${{ steps.test_main.outputs.PASSED }}\n‚Ä¢ Errors: ${{ steps.test_main.outputs.ERRORS }}\n‚Ä¢ Warnings: ${{ steps.test_main.outputs.WARNINGS }}"
                  }
                }$POST_SECTION,
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Triggered by *${{ github.actor }}* | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                    }
                  ]
                }
              ]
            }
          ]
        }
        EOF

        echo "‚úÖ Slack notification sent"

    - name: Fail workflow if tests failed
      if: steps.test_main.outputs.EXIT_CODE != '0'
      run: |
        echo "‚ùå Tests failed with exit code ${{ steps.test_main.outputs.EXIT_CODE }}"
        exit 1
