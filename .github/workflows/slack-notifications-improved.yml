# Reusable Slack notification workflow
# Call this from other workflows for consistent notifications

name: Send Slack Notification

on:
  workflow_call:
    inputs:
      status:
        required: true
        type: string
        description: 'Notification status (success, failure, warning)'
      title:
        required: true
        type: string
        description: 'Notification title'
      message:
        required: true
        type: string
        description: 'Notification message'
      channel:
        required: false
        type: string
        default: '#web'
        description: 'Slack channel to post to'
      include_metrics:
        required: false
        type: boolean
        default: false
        description: 'Include build metrics'
      html_count:
        required: false
        type: string
        description: 'Number of HTML files generated'
      total_size:
        required: false
        type: string
        description: 'Total site size'
      optimized_count:
        required: false
        type: string
        description: 'Number of images optimized'
      skipped_count:
        required: false
        type: string
        description: 'Number of images skipped'
      saved_mb:
        required: false
        type: string
        description: 'MB saved through optimization'
    secrets:
      SLACK_WEBHOOK_URL:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Determine color and emoji
        id: status_info
        run: |
          case "${{ inputs.status }}" in
            success)
              echo "color=good" >> $GITHUB_OUTPUT
              echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
              ;;
            failure)
              echo "color=danger" >> $GITHUB_OUTPUT
              echo "emoji=‚ùå" >> $GITHUB_OUTPUT
              ;;
            warning)
              echo "color=warning" >> $GITHUB_OUTPUT
              echo "emoji=‚ö†Ô∏è" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "color=#808080" >> $GITHUB_OUTPUT
              echo "emoji=‚ÑπÔ∏è" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build metrics section
        id: metrics
        if: inputs.include_metrics == true
        run: |
          METRICS="*üìä Build Metrics:*\n"
          METRICS+="‚Ä¢ HTML Pages: ${{ inputs.html_count }}\n"
          METRICS+="‚Ä¢ Site Size: ${{ inputs.total_size }}\n"
          METRICS+="‚Ä¢ Images Optimized: ${{ inputs.optimized_count }} (skipped: ${{ inputs.skipped_count }})\n"
          METRICS+="‚Ä¢ Space Saved: ${{ inputs.saved_mb }}MB"
          echo "metrics<<EOF" >> $GITHUB_OUTPUT
          echo -e "$METRICS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build commit info
        id: commit_info
        run: |
          # Handle both push and workflow_dispatch events
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            COMMIT_INFO="*üìù Trigger Info:*\n"
            COMMIT_INFO+="‚Ä¢ Type: Manual workflow dispatch\n"
            COMMIT_INFO+="‚Ä¢ Actor: ${{ github.actor }}\n"
            COMMIT_INFO+="‚Ä¢ Ref: ${{ github.ref_name }}"
          else
            COMMIT_INFO="*üìù Commit Info:*\n"
            COMMIT_INFO+="‚Ä¢ Time: ${{ github.event.head_commit.timestamp || 'N/A' }}\n"
            COMMIT_INFO+="‚Ä¢ Message: ${{ github.event.head_commit.message || 'N/A' }}\n"
            COMMIT_INFO+="‚Ä¢ Author: ${{ github.event.head_commit.author.name || github.actor }}"
          fi
          echo "commit_info<<EOF" >> $GITHUB_OUTPUT
          echo -e "$COMMIT_INFO" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "channel": "${{ inputs.channel }}",
              "username": "GitHub Actions",
              "icon_emoji": ":github:",
              "attachments": [
                {
                  "color": "${{ steps.status_info.outputs.color }}",
                  "title": "${{ steps.status_info.outputs.emoji }} ${{ inputs.title }}",
                  "text": "${{ inputs.message }}\n\n${{ steps.commit_info.outputs.commit_info }}${{ inputs.include_metrics == true && format('\n\n{0}', steps.metrics.outputs.metrics) || '' }}",
                  "footer": "GitHub Actions",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "ts": ${{ github.event.head_commit.timestamp && 'github.event.head_commit.timestamp' || 'github.event.created_at' }},
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Workflow",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
