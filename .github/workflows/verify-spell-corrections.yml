name: Verify Spelling Corrections

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID from the spell check workflow that generated corrections'
        required: true
      corrections_file:
        description: 'Path to corrections file (optional, will download from artifact if not provided)'
        required: false
        default: ''

jobs:
  verify:
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4
        
    - name: Download corrections artifact
      if: github.event.inputs.corrections_file == ''
      uses: actions/download-artifact@v4
      with:
        name: spelling-corrections-${{ github.event.inputs.run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.inputs.run_id }}
        
    - name: Verify corrections file exists
      run: |
        if [ -n "${{ github.event.inputs.corrections_file }}" ]; then
          CORRECTIONS_FILE="${{ github.event.inputs.corrections_file }}"
        else
          CORRECTIONS_FILE="spelling_corrections.json"
        fi
        
        if [ ! -f "$CORRECTIONS_FILE" ]; then
          echo "‚ùå Corrections file not found: $CORRECTIONS_FILE"
          exit 1
        fi
        
        echo "‚úÖ Found corrections file: $CORRECTIONS_FILE"
        echo "CORRECTIONS_FILE=$CORRECTIONS_FILE" >> $GITHUB_ENV
        
    - name: Verify corrections were applied
      env:
        WP_AUTH_TOKEN: ${{ secrets.WP_AUTH_TOKEN }}
        WP_URL: https://wordpress.jameskilby.cloud
      run: |
        echo "üîç Verifying spelling corrections..."
        echo ""
        
        ./verify_spelling_corrections.py "$CORRECTIONS_FILE" > verification_report.txt 2>&1
        VERIFY_EXIT=$?
        
        # Display the report
        cat verification_report.txt
        
        echo ""
        echo "VERIFY_EXIT_CODE=$VERIFY_EXIT" >> $GITHUB_ENV
        
        exit $VERIFY_EXIT
        
    - name: Upload verification report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: verification-report-${{ github.run_id }}
        path: verification_report.txt
        retention-days: 7
        
    - name: Comment on issue if verification failed
      if: failure() && env.VERIFY_EXIT_CODE == '1'
      uses: actions/github-script@v7
      with:
        script: |
          // Find the spell check issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            labels: 'spell-check',
            per_page: 10
          });
          
          // Find issue with matching run ID
          const runId = '${{ github.event.inputs.run_id }}';
          const matchingIssue = issues.data.find(issue => 
            issue.title.includes(`Run #${runId}`) ||
            issue.body.includes(`run_id=${runId}`)
          );
          
          if (matchingIssue) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: matchingIssue.number,
              body: `‚ö†Ô∏è **Verification Failed**\n\nSome corrections were NOT applied to WordPress.\n\nSee the [verification report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
            });
          }
        
    - name: Notify Slack
      if: always()
      uses: slackapi/slack-github-action@v2.0.0
      with:
        webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
        webhook-type: incoming-webhook
        payload: |
          {
            "channel": "#web",
            "username": "GitHub Actions",
            "icon_emoji": ":github:",
            "attachments": [
              {
                "color": "${{ env.VERIFY_EXIT_CODE == '0' && 'good' || 'warning' }}",
                "title": "${{ env.VERIFY_EXIT_CODE == '0' && '‚úÖ Spelling Corrections Verified' || '‚ö†Ô∏è Spelling Corrections Not Applied' }}",
                "text": "${{ env.VERIFY_EXIT_CODE == '0' && 'All corrections have been successfully applied to WordPress.' || 'Some corrections were not applied to WordPress. Please review the report.' }}",
                "fields": [
                  {
                    "title": "Run ID",
                    "value": "${{ github.event.inputs.run_id }}",
                    "short": true
                  },
                  {
                    "title": "Verified By",
                    "value": "${{ github.actor }}",
                    "short": true
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Report",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
