# IndexNow Implementation

## Overview

This project uses IndexNow to instantly notify search engines (Bing, Yandex, etc.) about content updates. IndexNow is a protocol that allows website owners to notify search engines immediately when URLs are added, updated, or deleted, rather than waiting for search engines to discover changes through traditional crawling.

## What is IndexNow?

IndexNow is a simple protocol that allows websites to notify search engines about content changes in real-time:
- **Instant notifications**: Search engines are notified immediately rather than waiting days/weeks for crawling
- **Participating search engines**: Bing, Yandex, Seznam.cz, Naver, and more
- **Single endpoint**: Notify one participating search engine, and the notification is shared with all others
- **Free to use**: No cost, no rate limits (beyond 10,000 URLs per request)

Learn more: https://www.indexnow.org/

## Implementation

### Files

- **`submit_indexnow.py`** - Main script that submits URLs to IndexNow
- **`.indexnow_key`** - API key file (auto-generated, tracked in git)
- **`indexnow-submission.json`** - Submission history log (last 30 submissions)
- **`public/{key}.txt`** - Key verification file (hosted on the site)

### How It Works

1. **Key Generation**: On first run, a UUID-based API key is generated and saved to `.indexnow_key`
2. **Key Verification File**: A text file named `{key}.txt` containing the key is created in the site root
3. **URL Collection**: All HTML pages are discovered from the static site
4. **Submission**: URLs are submitted to IndexNow endpoints (api.indexnow.org, bing.com, yandex.com)
5. **Logging**: Results are saved to `indexnow-submission.json`

### GitHub Actions Integration

The IndexNow submission is integrated into the deployment workflow (`.github/workflows/deploy-static-site.yml`):

```yaml
# Submit to IndexNow (notify search engines about all pages)
echo "üîî Submitting URLs to IndexNow..."
python3 submit_indexnow.py ./public || echo "‚ö†Ô∏è  IndexNow submission failed (non-blocking)"
```

**When it runs**: After the static site is generated and before committing to git

**Non-blocking**: If IndexNow submission fails, the workflow continues (deployment is not blocked)

### Files Tracked in Git

The workflow commits these IndexNow-related files:
- `.indexnow_key` - Persistent API key (reused across builds)
- `indexnow-submission.json` - Submission history
- `public/{key}.txt` - Key verification file (deployed to production)

## Usage

### Manual Execution

To manually submit URLs to IndexNow:

```bash
# From the repository root
python3 submit_indexnow.py ./public
```

### Command-Line Options

```bash
python3 submit_indexnow.py <output_directory>
```

**Arguments**:
- `output_directory` - Path to the static site directory (e.g., `./public` or `./static-output`)

### What Gets Submitted

The script submits **all HTML pages** from the static site:
- Homepage (`/`)
- Blog posts (`/2025/12/example-post/`)
- Pages (`/about/`, `/contact/`)
- Category archives (`/category/tech/`)
- Tag archives (`/tag/kubernetes/`)

### Batch Limits

- Maximum 10,000 URLs per request (IndexNow protocol limit)
- Automatically batches larger sites into multiple requests
- Currently submits all URLs in a single batch (typical site has < 500 pages)

## Key Verification

IndexNow requires proof of domain ownership via a key verification file.

### Verification File Location

The key file must be accessible at:
```
https://jameskilby.co.uk/{api_key}.txt
```

Example:
```
https://jameskilby.co.uk/a1b2c3d4-e5f6-7890-abcd-ef1234567890.txt
```

### Verification File Contents

The file contains only the API key itself:
```
a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

### Deployment

The verification file is automatically:
1. Generated by `submit_indexnow.py`
2. Placed in `public/{key}.txt`
3. Committed to git
4. Deployed to Cloudflare Pages

No manual configuration needed!

## Endpoints

The script tries multiple IndexNow endpoints in order:

1. **https://api.indexnow.org/indexnow** - General endpoint (recommended)
2. **https://www.bing.com/indexnow** - Bing endpoint
3. **https://yandex.com/indexnow** - Yandex endpoint

**Note**: Submitting to any one endpoint notifies all participating search engines.

## Response Codes

- **200** - Success (URLs accepted)
- **202** - Accepted (URLs queued for processing)
- **400** - Bad request (invalid payload)
- **403** - Forbidden (key verification failed)
- **422** - Unprocessable (invalid URLs or format)
- **429** - Too many requests (rate limited)

## Submission Log

Results are saved to `indexnow-submission.json`:

```json
[
  {
    "timestamp": "2025-12-23T15:30:00Z",
    "site_domain": "https://jameskilby.co.uk",
    "results": {
      "total_urls": 156,
      "batches": 1,
      "successful_batches": 1,
      "failed_batches": 0,
      "responses": [
        {
          "batch": 1,
          "endpoint": "https://api.indexnow.org/indexnow",
          "status_code": 200,
          "success": true
        }
      ]
    }
  }
]
```

The log keeps the last 30 submissions for historical tracking.

## Benefits

### Traditional Crawling
- Search engines discover changes by periodically crawling your site
- Can take **days or weeks** for new content to be indexed
- Wastes crawler resources on unchanged pages
- No control over when content is discovered

### With IndexNow
- Search engines are notified **immediately** about changes
- Content can be indexed within **minutes or hours**
- Efficient - only changed URLs are submitted
- Full control over what gets indexed

## Frequency

IndexNow submissions run:
- **Every deployment** (GitHub Actions workflow)
- Submits **all pages** each time (not incremental)
- **Non-blocking** - failures don't prevent deployment

### Why Submit All Pages?

Even though not all pages change, submitting all pages on each deployment:
- Ensures search engines have the complete site map
- Simple implementation (no change tracking needed)
- No performance impact (IndexNow has no rate limits)
- Handles URL changes/additions automatically

## Troubleshooting

### Submission Fails with 403

**Problem**: Key verification failed

**Solution**:
1. Check that `{key}.txt` exists in `public/`
2. Verify the file is deployed to production
3. Test access: `curl https://jameskilby.co.uk/{key}.txt`
4. Ensure file content matches `.indexnow_key`

### Submission Fails with 422

**Problem**: Invalid URL format or domain mismatch

**Solution**:
1. Check that all URLs use the correct domain (`jameskilby.co.uk`)
2. Ensure URLs are properly formatted (absolute URLs)
3. Verify host in payload matches the site domain

### No Response / Timeout

**Problem**: Network connectivity or endpoint unavailable

**Solution**:
- Script automatically tries multiple endpoints
- Non-blocking in CI/CD - will retry on next deployment
- Check `indexnow-submission.json` for error details

### Key File Not Created

**Problem**: Script runs but no key file in output

**Solution**:
1. Ensure script has write permissions
2. Check that output directory exists
3. Verify `public/` directory is correct location

## Search Engine Support

### Confirmed Support
- **Microsoft Bing** ‚úÖ
- **Yandex** ‚úÖ
- **Seznam.cz** ‚úÖ
- **Naver** ‚úÖ

### Google
- Google does **not** currently support IndexNow
- Use traditional sitemaps and Search Console for Google
- Google has their own Indexing API (different protocol)

## Related Files

- **`wp_to_static_generator.py`** - Generates the static site
- **`.github/workflows/deploy-static-site.yml`** - Deployment workflow
- **`public/sitemap.xml`** - XML sitemap (traditional method)
- **`public/robots.txt`** - Includes sitemap reference

## Best Practices

1. **Keep the key secret**: The `.indexnow_key` file should be tracked in git but treat it like a password
2. **Monitor submission logs**: Check `indexnow-submission.json` for failures
3. **Verify key file accessibility**: Test `https://jameskilby.co.uk/{key}.txt` after deployment
4. **Don't abuse the API**: Submit only when content actually changes (our workflow does this automatically)

## Future Enhancements

Possible improvements:
- **Incremental submissions**: Only submit changed URLs (requires change tracking)
- **Delete notifications**: Notify when URLs are removed
- **Multiple domains**: Support for staging site (jkcoukblog.pages.dev)
- **Retry logic**: Exponential backoff for failed submissions
- **Analytics**: Track indexing speed improvements

## References

- [IndexNow Documentation](https://www.indexnow.org/documentation)
- [Bing IndexNow Guide](https://www.bing.com/indexnow)
- [IndexNow GitHub](https://github.com/microsoft/IndexNow)
